\documentclass[10pt]{article}
%\usepackage[left=2.3cm,right=2.3cm,top=2.5cm,bottom=3cm,a4paper]{geometry}
\usepackage{fullpage}
\usepackage{setspace}
\setstretch{1.3}
\usepackage{amsmath,amssymb,amsthm,physics,units,mathtools,bm}
\usepackage{mdwlist}
\usepackage{paralist}
\setlength\parindent{0pt}
\usepackage{float}
\usepackage{xcolor}
\usepackage{algorithm,algpseudocode}
\usepackage{listings}
\usepackage[colorlinks=true]{hyperref}

\NewDocumentCommand{\code}{v}{%
\texttt{#1}%
}

\DeclareMathOperator*{\argmax}{argmax\,}
\DeclareMathOperator*{\argmin}{argmin\,}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{lgray}{RGB}{240,239,239}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{
    % frame=tb,
    aboveskip=3mm,
    belowskip=3mm,
    showstringspaces=false,
    columns=flexible,
    basicstyle=\ttfamily,
    numbers=none,
    backgroundcolor=\color{lgray},
    numberstyle=\tiny\color{gray},
    keywordstyle=\color{blue},
    commentstyle=\color{dkgreen},
    stringstyle=\color{mauve},                
    keepspaces=true,
    breaklines=true,
    breakatwhitespace=true,
    tabsize=3
}

\begin{document}
\begin{center}
    {\LARGE MathDNN Homework 10} \\
\end{center}
\begin{flushright}
    Department of Computer Science and Engineering \\
    2021-16988 Jaewan Park
\end{flushright}

\section*{Problem 1}
Expansion over the expectation operator gives the following.
\begin{align*}
    \nabla_{\phi}\mathbb{E}_{Z \sim q_\phi(z)}\qty[\log\qty(\frac{h(Z)}{q_{\phi}(Z)})]
    &= \nabla_{\phi}\int_{\mathbb{R}^k}\log\qty(\frac{h(z)}{q_{\phi}(z)})q_\phi(z)dz \\
    &= \int_{\mathbb{R}^k}\qty(\nabla_{\phi}\log\qty(\frac{h(z)}{q_{\phi}(z)})q_\phi(z) + \log\qty(\frac{h(z)}{q_{\phi}(z)})\nabla_{\phi}q_\phi(z))dz \\
    &= \int_{\mathbb{R}^k}\qty(-\frac{\nabla_\phi q_\phi(z)}{q_\phi(z)}q_\phi(z) + \log\qty(\frac{h(z)}{q_{\phi}(z)})\nabla_{\phi}q_\phi(z))dz \\
    &= \int_{\mathbb{R}^k}\log\qty(\frac{h(z)}{q_{\phi}(z)})\nabla_{\phi}q_\phi(z)dz = \int_{\mathbb{R}^k}\log\qty(\frac{h(z)}{q_{\phi}(z)})\frac{\nabla_{\phi}q_\phi(z)}{q_\phi(z)}q_\phi(z)dz \\
    &= \mathbb{E}_{Z \sim q_\phi(z)}\qty[\qty(\nabla_\phi\log q_\phi(Z))\log\qty(\frac{h(Z)}{q_\phi(Z)})]
\end{align*}

\section*{Problem 2}
Since $C = \qty{x \in \mathbb{R}^2 \,|\, x_1 = a,\, 0 \leq x_2 \leq 1}$, we obtain the following.
\begin{align*}
    \Pi_C(y) &= \argmin_{x \in C}\lVert x-y \rVert^2 = \argmin_{x \in C}\qty{\qty(a - y_1)^2 + \qty(x_2 - y_2)^2} = \argmin_{x \in C}\qty(x_2 - y_2)^2 \\
    &= \begin{bmatrix}
        a \\ \min\qty{\max\qty{y_2, 0}, 1}
    \end{bmatrix} \;\; \qty(\because 0 \leq x _2 \leq 1)
\end{align*}

\section*{Problem 4}
\begin{enumerate}[(a)]
    \item Since $f_1(x) = Ax = PL(U+\mathrm{diag}(s))x$, we obtain the following.
    \begin{align*}
        \log\qty|\frac{\partial f_1}{\partial x}| 
        &= \log\qty|A| = \log\qty|PL\qty(U+\mathrm{diag}(s))| = \log\qty(|P||L||U+\mathrm{diag}(s)|) = \log|\mathrm{diag}(s)| \\
        &= \sum_{i=1}^{C}\log\qty|s_i|
    \end{align*}
    \item Different choices of reshape results differ by permutations,
    i.e., multiplying a permutation matrix to one result of reshape gives another possible result of reshape.
    Let $x, y \in \mathbb{R}^{abc}$, and $P \in \mathbb{R}^{abc}$ a permutation matrix.
    We obtain the following.
    \begin{align*}
        \qty|\frac{\partial (Py)}{\partial (Px)}| &= \qty|\frac{\partial (Py)}{\partial y}\frac{\partial y}{\partial x}\frac{\partial x}{\partial (Px)}| = |P|\qty|\frac{\partial y}{\partial x}|\frac{1}{|P|} = \qty|\frac{\partial y}{\partial x}|
    \end{align*}
    Therefore Jacobian determinants between two vectors or between their permutations give the same result.
    Therefore the choice of reshape does not matter in the given calculation.
    \item Select the reshape operator as reshaping $X \in \mathbb{R}^{C \times m \times n}$ into 
    $$\qty(X_{1, 1, 1}, X_{2, 1, 1}, \cdots, X_{C, 1, 1}, X_{1, 2, 1}, X_{2, 2, 1}, \cdots, X_{C, 2, 1}, \cdots, X_{1, m, n}, X_{2, m, n}, \cdots, X_{C, m, n}).$$
    Then we know
    $$f_2(X \,|\, P, L, U, s).\mathrm{reshape}(Cmn) = \begin{bmatrix}
        A &        & 0 \\
          & \ddots &   \\
        0 &        & A
    \end{bmatrix}X.\mathrm{reshape}(Cmn)$$
    where the $A$s in the diagonal are repeated $mn$ times. Therefore using the result of (a), we obtain the following.
    \begin{align*}
        \log\qty|\frac{\partial f_2(X \,|\, P, L, U, s)}{\partial X}| &= \log\qty|\frac{\partial f_2(X \,|\, P, L, U, s).\mathrm{reshape}(Cmn)}{\partial X.\mathrm{reshape}(Cmn)}| \\
        &= \log\begin{vmatrix}
            A &        & 0 \\
            & \ddots &   \\
          0 &        & A
        \end{vmatrix} = \log|A|^{mn} = mn\log|A| = mn\sum_{i=1}^{C}\log\qty|s_i|
    \end{align*}
    \item Select the reshape operator as reshaping $X \in \mathbb{R}^{2C \times m \times n}$ into 
    $$\qty(X_{1, 1, 1}, \cdots, X_{C, 1, 1}, \cdots, X_{1, m, n}, \cdots, X_{C, m, n}, X_{C+1, 1, 1}, \cdots, X_{2C, 1, 1}, \cdots, X_{C+1, m, n}, \cdots, X_{2C, m, n}).$$
    Then we know
    $$Z.\mathrm{reshape}(2Cmn) = \begin{bmatrix}
        I &   &        & 0 \\
          & A &        &   \\
          &   & \ddots &   \\
        0 &   &        & A
    \end{bmatrix}X.\mathrm{reshape}(2Cmn)$$
    where $I \in \mathbb{R}^{Cmn \times Cmn}$ and the $A$s in the diagonal are repeated $mn$ times.
    Therefore using the result of (a), we obtain the following.
    \begin{align*}
        \log\qty|\frac{\partial Z}{\partial X}| &= \log\qty|\frac{\partial Z.\mathrm{reshape}(2Cmn)}{\partial X.\mathrm{reshape}(2Cmn)}| \\
        &= \log\begin{vmatrix}
            I &   &        & 0 \\
              & A &        &   \\
              &   & \ddots &   \\
            0 &   &        & A
        \end{vmatrix} = \log|A|^{mn} = mn\log|A| = mn\sum_{i=1}^{C}\log\qty|s_i|
    \end{align*}
\end{enumerate}

\end{document}